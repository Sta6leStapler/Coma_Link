<!DOCTYPE html>
<html lang="ja" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>ãƒã‚¤ãƒšãƒ¼ã‚¸ | Comaâ€‘Link</title>
  <style>
    :root {
      --bg: #f9f9f9;
      --fg: #333;
      --panel: #fff;
      --border: #ddd;
      --highlight: #b2fab4;
      --primary: #2196f3;
    }
    html[data-theme="dark"] {
      --bg: #2b2b2b;
      --fg: #ddd;
      --panel: #3b3b3b;
      --border: #555;
      --highlight: #4caf50;
      --primary: #1976d2;
    }
    *, *::before, *::after { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--fg);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* â€”â€”â€” ãƒ˜ãƒƒãƒ€ãƒ¼ â€”â€”â€” */
    header {
      background: var(--panel);
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
    }
    header h1 { font-size: 1.2em; margin:0; }
    .header-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .header-controls button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 18px;
      color: var(--fg);
    }
    .header-controls button.logout {
      font-size: 14px;
      padding: 4px 8px;
      background: var(--primary);
      color: #fff;
      border-radius: 4px;
    }

    /* â€”â€”â€” ãƒŠãƒ“ â€”â€”â€” */
    .toolbar {
      display: flex;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
    }
    .toolbar button {
      flex: 1;
      padding: 8px;
      background: var(--panel);
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    .toolbar button.active {
      background: var(--highlight);
      color: #fff;
    }

    /* â€”â€”â€” ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ â€”â€”â€” */
    main {
      flex: 1;
      padding: 20px;
    }
    h2 {
      margin-top: 20px;
      margin-bottom: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--panel);
    }
    th, td {
      border: 1px solid var(--border);
      padding: 8px;
      text-align: center;
    }
    th {
      background: #eee;
    }
  </style>
</head>
<body>
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header>
    <h1>Comaâ€‘Link</h1>
    <div class="header-controls">
      <button id="themeToggle">ğŸŒ™</button>
      <button class="logout" id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </header>

  <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <div class="toolbar">
    <button onclick="location.href='jikanwari.html'">æ™‚é–“å‰²</button>
    <button onclick="location.href='board.html'">å‹Ÿé›†æ²ç¤ºæ¿</button>
    <button onclick="location.href='calendar.html'">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>
    <button onclick="location.href='connect.html'">ã¤ãªãŒã‚‹</button>
    <button onclick="location.href='chat.html'">ãƒãƒ£ãƒƒãƒˆ</button>
    <button class="active">ãƒã‚¤ãƒšãƒ¼ã‚¸</button>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main>
    <h1>ã‚ˆã†ã“ãã€<span id="userName"></span> ã•ã‚“ï¼</h1>

    <!-- ä»Šæ—¥ã®æˆæ¥­ -->
    <section>
      <h2>ä»Šæ—¥ã®æ™‚é–“å‰²ï¼ˆæˆæ¥­ï¼‰</h2>
      <table id="ttTable">
        <thead>
          <tr>
            <th>æ›œæ—¥</th>
            <th>é™</th>
            <th>æˆæ¥­åï¼æ•™å®¤</th>
          </tr>
        </thead>
        <tbody>
          <!-- JavaScript ã§åŸ‹ã‚è¾¼ã¿ -->
        </tbody>
      </table>
    </section>

    <!-- ä»Šæ—¥ã®ã‚³ãƒæ™‚é–“ -->
    <section>
      <h2>ä»Šæ—¥ã®ã‚³ãƒæ™‚é–“</h2>
      <table id="comaTable">
        <thead>
          <tr>
            <th>æ›œæ—¥</th>
            <th>é–‹å§‹</th>
            <th>çµ‚äº†</th>
            <th>å†…å®¹</th>
          </tr>
        </thead>
        <tbody>
          <!-- JavaScript ã§åŸ‹ã‚è¾¼ã¿ -->
        </tbody>
      </table>
    </section>

    <!-- å±Šã„ãŸå‚åŠ ç”³è«‹ -->
    <section>
      <h2>å±Šã„ãŸå‚åŠ ç”³è«‹</h2>
      <table id="applicationTable">
        <thead>
          <tr>
            <th>å‹Ÿé›†ã‚¿ã‚¤ãƒˆãƒ«</th>
            <th>ç”³è«‹è€…</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          </tbody>
      </table>
    </section>
  </main>

  <script>
    // --- ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯ & ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤º ---
    const user = localStorage.getItem('coma_user');
    if (!user) {
      alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
      location.href = 'login.html';
    }
    document.getElementById('userName').textContent = user;

    // --- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç† ---
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('coma_user');
      location.href = 'login.html';
    });

    // --- API ãƒ™ãƒ¼ã‚¹ URL ---
    const API = 'http://127.0.0.1:5000';

    // --- ä»Šæ—¥ã®æ›œæ—¥ã‚’æ—¥æœ¬èªã§å–å¾— ---
    const jpWeek = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
    const today = new Date();
    const todayJP = jpWeek[today.getDay()];

    // --- ãƒ†ãƒ¼ãƒ–ãƒ«è¦ç´ å–å¾— ---
    const ttBody = document.querySelector('#ttTable tbody');
    const comaBody = document.querySelector('#comaTable tbody');
    const appBody = document.querySelector('#applicationTable tbody');

    // --- ä»Šæ—¥ã®æˆæ¥­å–å¾— & æç”» ---
    async function loadCourses() {
      const res = await fetch(`${API}/courses?username=${encodeURIComponent(user)}`);
      const list = await res.json();
      const todayList = list.filter(c => c.day === todayJP);
      ttBody.innerHTML = '';
      if (todayList.length) {
        todayList.forEach(c => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${c.day}</td>
            <td>${c.slot}é™</td>
            <td>${c.content || '-'}</td>
          `;
          ttBody.appendChild(tr);
        });
      } else {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="3">ä»Šæ—¥ã®æˆæ¥­ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td>`;
        ttBody.appendChild(tr);
      }
    }

    // --- ä»Šæ—¥ã®ã‚³ãƒæ™‚é–“å–å¾— & æç”» ---
    async function loadComas() {
      const res = await fetch(`${API}/custom_slots?username=${encodeURIComponent(user)}`);
      const list = await res.json();
      const todayList = list.filter(c => c.day === todayJP);
      comaBody.innerHTML = '';
      if (todayList.length) {
        todayList.forEach(c => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${c.day}</td>
            <td>${c.start_time}</td>
            <td>${c.end_time}</td>
            <td>${c.content || '-'}</td>
          `;
          comaBody.appendChild(tr);
        });
      } else {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="4">ä»Šæ—¥ã®ã‚³ãƒæ™‚é–“ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td>`;
        comaBody.appendChild(tr);
      }
    }

    // --- å‚åŠ ç”³è«‹ã‚’èª­ã¿è¾¼ã‚€é–¢æ•° ---
    async function loadApplications() {
      const res = await fetch(`${API}/my_recruitments/applications?username=${encodeURIComponent(user)}`);
      const list = await res.json();
      appBody.innerHTML = ''; // ã‚¯ãƒªã‚¢
      if (list.length) {
        list.forEach(app => {
          const tr = document.createElement('tr');
          tr.id = `app-row-${app.id}`; // è¡Œã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã®ID
          tr.innerHTML = `
            <td>${app.title}</td>
            <td>${app.applicant_username}</td>
            <td>
              <button onclick="handleApplication(${app.id}, 'approved')">æ‰¿èª</button>
              <button onclick="handleApplication(${app.id}, 'rejected')">æ‹’å¦</button>
            </td>
          `;
          appBody.appendChild(tr);
        });
      } else {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="3">æ–°ã—ã„å‚åŠ ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“</td>`;
        appBody.appendChild(tr);
      }
    }

    // --- ç”³è«‹ã‚’æ‰¿èª/æ‹’å¦ã™ã‚‹é–¢æ•° ---
    async function handleApplication(appId, status) {
      const res = await fetch(`${API}/applications/${appId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: status })
      });
      const data = await res.json();
      if (data.success) {
        alert(`ç”³è«‹ã‚’${status === 'approved' ? 'æ‰¿èª' : 'æ‹’å¦'}ã—ã¾ã—ãŸã€‚`);
        // æˆåŠŸã—ãŸã‚‰ç”»é¢ã‹ã‚‰ãã®è¡Œã‚’å‰Šé™¤
        document.getElementById(`app-row-${appId}`).remove();
      } else {
        alert('æ“ä½œã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      }
    }

    // --- ãƒ†ãƒ¼ãƒåˆ‡æ›¿ ---
    const tt = document.getElementById('themeToggle');
    function applyTheme(t) {
      document.documentElement.setAttribute('data-theme', t);
      tt.textContent = t === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
      localStorage.setItem('coma_theme', t);
    }
    tt.addEventListener('click', () => {
      applyTheme(document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light');
    });
    applyTheme(localStorage.getItem('coma_theme') || 'light');

    // --- åˆæœŸãƒ­ãƒ¼ãƒ‰ ---
    loadCourses();
    loadComas();
    loadApplications();
  </script>
</body>
</html>
