<!DOCTYPE html>
<html lang="ja" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å‹Ÿé›†æ²ç¤ºæ¿ | Comaâ€‘Link</title>
  <style>
    /* mypage.htmlã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™ */
    :root { --bg: #f9f9f9; --fg: #333; --panel: #fff; --border: #ddd; --highlight: #b2fab4; --primary: #2196f3; --tag-bg: #e0e0e0; }
    html[data-theme="dark"] { --bg: #2b2b2b; --fg: #ddd; --panel: #3b3b3b; --border: #555; --highlight: #4caf50; --primary: #1976d2; --tag-bg: #4f4f4f; }
    body { font-family: Arial, sans-serif; background: var(--bg); color: var(--fg); margin: 0; padding: 0; }
    header { background: var(--panel); padding: 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
    header h1 { font-size: 1.2em; }
    header button { background: none; border: none; cursor: pointer; font-size: 18px; color: var(--fg); }
    .toolbar { display: flex; background: var(--panel); border-bottom: 1px solid var(--border); }
    .toolbar button { flex: 1; padding: 8px; background: var(--panel); border: none; cursor: pointer; font-size: 14px; }
    .toolbar button.active { background: var(--highlight); color: #fff; }
    main { padding: 20px; }
    .filter-section { background: var(--panel); padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
    .filter-section input { padding: 8px; border: 1px solid var(--border); border-radius: 4px; background-color: var(--bg); color: var(--fg); }
    .create-btn { display: block; width: 100%; padding: 12px; background: var(--primary); color: #fff; text-align: center; border-radius: 8px; text-decoration: none; font-weight: bold; margin-bottom: 20px; }
    .recruitment-card { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
    .recruitment-card h3 { margin: 0 0 10px 0; }
    .recruitment-card .tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
    .recruitment-card .tag { background: var(--tag-bg); color: var(--fg); padding: 4px 8px; border-radius: 12px; font-size: 12px; }
    .recruitment-card .apply-btn { float: right; padding: 6px 12px; background: var(--primary); color: #fff; border: none; border-radius: 4px; cursor: pointer; }
  </style>
</head>
<body>
  <header>
    <h1>Comaâ€‘Link</h1>
    <button id="themeToggle">ğŸŒ™</button>
  </header>

  <div class="toolbar">
    <button onclick="location.href='jikanwari.html'">æ™‚é–“å‰²</button>
    <button onclick="location.href='board.html'" class="active">å‹Ÿé›†æ²ç¤ºæ¿</button>
    <button onclick="location.href='mypage.html'">ãƒã‚¤ãƒšãƒ¼ã‚¸</button>
  </div>

  <main>
    <div class="filter-section">
      <input type="text" id="filterCategory" placeholder="ã‚«ãƒ†ã‚´ãƒªã§æ¤œç´¢...">
      <input type="text" id="filterLocation" placeholder="å ´æ‰€ã§æ¤œç´¢...">
    </div>

    <a href="create_recruitment.html" class="create-btn">ï¼‹ æ–°ã—ã„å‹Ÿé›†ã‚’ä½œæˆã™ã‚‹</a>

    <div id="recruitment-list">
      </div>
  </main>

  <script>
    const API = 'http://127.0.0.1:5000';
    const user = localStorage.getItem('coma_user');
    if (!user) {
      alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
      location.href = 'login.html';
    }

    const recruitmentList = document.getElementById('recruitment-list');
    const filterCategory = document.getElementById('filterCategory');
    const filterLocation = document.getElementById('filterLocation');

    // å‹Ÿé›†ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤ºã™ã‚‹é–¢æ•°
    async function loadRecruitments() {
      let url = `${API}/recruitments?`;
      const params = new URLSearchParams();
      if (filterCategory.value) params.append('category', filterCategory.value);
      if (filterLocation.value) params.append('location', filterLocation.value);
      
      const res = await fetch(url + params.toString());
      const recruitments = await res.json();
      
      recruitmentList.innerHTML = ''; // ä¸€æ—¦ã‚¯ãƒªã‚¢
      if (recruitments.length === 0) {
        recruitmentList.innerHTML = '<p>ç¾åœ¨ã€å‹Ÿé›†ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
      }

      recruitments.forEach(rec => {
        const card = document.createElement('div');
        card.className = 'recruitment-card';

        // æ—¥æ™‚ã‚’èª­ã¿ã‚„ã™ã„å½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        const startTime = new Date(rec.start_time).toLocaleString('ja-JP');
        const endTime = new Date(rec.end_time).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

        card.innerHTML = `
          <h3>${rec.title}</h3>
          <div class="tags">
            <span class="tag">ğŸ‘¤ ${rec.creator_username}</span>
            <span class="tag">ğŸ“ ${rec.category || 'æŒ‡å®šãªã—'}</span>
            <span class="tag">ğŸ“ ${rec.location || 'æŒ‡å®šãªã—'}</span>
            <span class="tag">ğŸ‘¥ ${rec.max_participants}äºº</span>
            <span class="tag">â° ${startTime} ~ ${endTime}</span>
          </div>
          <p>
            <button class="apply-btn" onclick="applyToRecruitment(${rec.id})">å‚åŠ ç”³è«‹</button>
          </p>
        `;
        recruitmentList.appendChild(card);
      });
    }

    // å‚åŠ ç”³è«‹ã‚’è¡Œã†é–¢æ•°
    async function applyToRecruitment(recId) {
      if (!confirm('ã“ã®å‹Ÿé›†ã«å‚åŠ ç”³è«‹ã—ã¾ã™ã‹ï¼Ÿ')) return;

      const res = await fetch(`${API}/recruitments/${recId}/apply`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ applicant_username: user })
      });
      const data = await res.json();
      if (data.success) {
        alert('å‚åŠ ç”³è«‹ã‚’é€ã‚Šã¾ã—ãŸï¼');
      } else {
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + data.message);
      }
    }
    
    // ãƒ•ã‚£ãƒ«ã‚¿å…¥åŠ›æ™‚ã«å†èª­ã¿è¾¼ã¿
    filterCategory.addEventListener('input', loadRecruitments);
    filterLocation.addEventListener('input', loadRecruitments);

    // ãƒ†ãƒ¼ãƒåˆ‡æ›¿ã®ãƒ­ã‚¸ãƒƒã‚¯ (mypage.htmlã‹ã‚‰ã‚³ãƒ”ãƒ¼)
    const tt = document.getElementById('themeToggle');
    function applyTheme(t) {
      document.documentElement.setAttribute('data-theme', t);
      tt.textContent = t === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
      localStorage.setItem('coma_theme', t);
    }
    tt.addEventListener('click', () => {
      applyTheme(document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light');
    });
    applyTheme(localStorage.getItem('coma_theme') || 'light');

    // åˆæœŸèª­ã¿è¾¼ã¿
    loadRecruitments();
  </script>
</body>
</html>